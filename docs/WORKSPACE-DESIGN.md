# Workspace

Workspace is a WebIDE and its deployment, networking and storage configurations.

In Kubernetes term, it is a set of Kubernetes resources such as Deployment, Service, Ingress, PersistentVolumeClaim and so on.

You can define them as a Template.

## Workspace Template

Workspace Template is a set of Kubernetes manifests.

It is defined as Kubernetes custom resource definition and created via kubectl.

Here is a example of Workspace Template

<details>
<summary>cosmo-template.yaml</summary>

```yaml
# Generated by cosmoctl template command
apiVersion: cosmo-workspace.github.io/v1alpha1
kind: Template
metadata:
  annotations:
    workspace.cosmo-workspace.github.io/deployment: code-server
    workspace.cosmo-workspace.github.io/ingress: code-server
    workspace.cosmo-workspace.github.io/service: code-server
    workspace.cosmo-workspace.github.io/service-main-port: http
    workspace.cosmo-workspace.github.io/urlbase: https://{{NETRULE_GROUP}}-{{INSTANCE}}-{{NAMESPACE}}.cosmo.example.com
  labels:
    cosmo-workspace.github.io/type: workspace
  name: code-server
spec:
  rawYaml: |
    apiVersion: v1
    kind: Service
    metadata:
      labels:
        cosmo-workspace.github.io/instance: '{{INSTANCE}}'
        cosmo-workspace.github.io/template: '{{TEMPLATE}}'
      name: '{{INSTANCE}}-code-server'
      namespace: '{{NAMESPACE}}'
    spec:
      ports:
      - name: http
        port: 8080
        protocol: TCP
        targetPort: http
      selector:
        cosmo-workspace.github.io/instance: '{{INSTANCE}}'
        cosmo-workspace.github.io/template: '{{TEMPLATE}}'
      type: ClusterIP
    ---
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      labels:
        cosmo-workspace.github.io/instance: '{{INSTANCE}}'
        cosmo-workspace.github.io/template: '{{TEMPLATE}}'
      name: '{{INSTANCE}}-code-server'
      namespace: '{{NAMESPACE}}'
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi
    ---
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      labels:
        cosmo-workspace.github.io/instance: '{{INSTANCE}}'
        cosmo-workspace.github.io/template: '{{TEMPLATE}}'
      name: '{{INSTANCE}}-code-server'
      namespace: '{{NAMESPACE}}'
    spec:
      replicas: 1
      selector:
        matchLabels:
          cosmo-workspace.github.io/instance: '{{INSTANCE}}'
          cosmo-workspace.github.io/template: '{{TEMPLATE}}'
      strategy:
        type: Recreate
      template:
        metadata:
          labels:
            cosmo-workspace.github.io/instance: '{{INSTANCE}}'
            cosmo-workspace.github.io/template: '{{TEMPLATE}}'
        spec:
          containers:
          - args:
            - --insecure
            env:
            - name: COSMO_AUTH_PROXY_INSTANCE
              value: '{{INSTANCE}}'
            - name: COSMO_AUTH_PROXY_NAMESPACE
              value: '{{NAMESPACE}}'
            image: ghcr.io/cosmo-workspace/cosmo-auth-proxy:latest
            name: cosmo-auth-proxy
          - args:
            - --auth=none
            image: codercom/code-server:3.12.0
            imagePullPolicy: Always
            livenessProbe:
              httpGet:
                path: /
                port: http
            name: code-server
            ports:
            - containerPort: 8080
              name: http
              protocol: TCP
            readinessProbe:
              httpGet:
                path: /
                port: http
            resources: {}
            securityContext:
              runAsUser: 1000
            volumeMounts:
            - mountPath: /home/coder
              name: data
          initContainers:
          - command:
            - sh
            - -c
            - |
              chown -R 1000:1000 /home/coder
            image: busybox:latest
            imagePullPolicy: IfNotPresent
            name: init-chmod-data
            securityContext:
              runAsUser: 0
            volumeMounts:
            - mountPath: /home/coder
              name: data
          securityContext:
            fsGroup: 1000
          serviceAccountName: default
          volumes:
          - name: data
            persistentVolumeClaim:
              claimName: '{{INSTANCE}}-code-server'
    ---
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      annotations:
        cert-manager.io/cluster-issuer: cosmo-selfsigned-clusterissuer
      labels:
        cosmo-workspace.github.io/instance: '{{INSTANCE}}'
        cosmo-workspace.github.io/template: '{{TEMPLATE}}'
      name: '{{INSTANCE}}-code-server'
      namespace: '{{NAMESPACE}}'
    spec:
      rules:
      - host: main-{{INSTANCE}}-{{NAMESPACE}}.cosmo.example.com
        http:
          paths:
          - backend:
              service:
                name: '{{INSTANCE}}-code-server'
                port: 
                  number: 8080
            path: /
            pathType: Prefix
      tls:
      - hosts:
        - '*.cosmo.example.com'
        secretName: '{{INSTANCE}}-code-server-cert'
```

</details><br>

Template may be little bit large and K8s YAMLs are in single string properties, but don't be afraid!

As you can see `# Generated by cosmoctl template command` top of the yaml, COSMO Template can be generated via `cosmoctl` from general Kubernetes YAML.

### How to create COSMO Template

1.  Prepare the set of Kubernetes YAML by your own.

    All you have to do is to prepare your own Kubernetes YAMLs that is deployable.

    For example, you prepare like here.

    ```sh
    $ pwd
    /tmp/code-server

    $ ls
    kustomization.yaml
    deployment.yaml
    service.yaml
    ingress.yaml
    pvc.yaml
    ```

    <details>
    <summary>kustomization.yaml</summary>

    ```yaml
    apiVersion: kustomize.config.k8s.io/v1beta1
    kind: Kustomization

    namespace: default

    resources:
    - deployment.yaml
    - service.yaml
    - ingress.yaml
    - pvc.yaml
    ```

    </details><br>

    <details>
    <summary>service.yaml</summary>

    ```yaml
    apiVersion: v1
    kind: Service
    metadata:
      name: code-server
    spec:
      ports:
      - name: http
        port: 8080
        protocol: TCP
        targetPort: http
      selector:
        app: code-server
      type: ClusterIP
    ```

    </details><br>

    <details>
    <summary>pvc.yaml</summary>

    ```yaml
    apiVersion: v1
    kind: PersistentVolumeClaim
    metadata:
      name: code-server
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi
    ```

    </details><br>

    <details>
    <summary>deployment.yaml</summary>

    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: code-server
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: code-server
      template:
        metadata:
          labels:
            app: code-server
        spec:
          containers:
          - args:
            - --auth=none
            image: codercom/code-server:3.12.0
            imagePullPolicy: Always
            livenessProbe:
              httpGet:
                path: /
                port: http
            name: code-server
            ports:
            - containerPort: 8080
              name: http
              protocol: TCP
            readinessProbe:
              httpGet:
                path: /
                port: http
            resources: {}
            securityContext:
              runAsUser: 1000
            volumeMounts:
            - mountPath: /home/coder
              name: data
          initContainers:
          - command:
            - sh
            - -c
            - |
              chown -R 1000:1000 /home/coder
            image: busybox:latest
            imagePullPolicy: IfNotPresent
            name: init-chmod-data
            securityContext:
              runAsUser: 0
            volumeMounts:
            - mountPath: /home/coder
              name: data
          securityContext:
            fsGroup: 1000
          serviceAccountName: default
          volumes:
          - name: data
            persistentVolumeClaim:
              claimName: code-server
    ```

    </details><br>

    <details>
    <summary>ingress.yaml</summary>

    ```yaml
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      annotations:
        cert-manager.io/cluster-issuer: cosmo-selfsigned-clusterissuer
      name: code-server
    spec:
      rules:
      - host: code-server.cosmo.example.com
        http:
          paths:
          - backend:
              service:
                name: code-server
                port: 
                  number: 8080
            path: /
            pathType: Prefix
      tls:
      - hosts:
        - '*.cosmo.example.com'
        secretName: code-server-cert
    ```

    </details><br>

    </details><br>

    Check these YAMLs can be deployed.

    ```sh
    kustomize build . | kubectl apply -f -
    ```

    Access `https://code-server.cosmo.example.com` from your browser.

    > ✅Note:
    >
    > Be sure it can be deployed as a single WebIDE deployment without any networking or storage troubles!
    >
    > Delete them after check. `kustomize build . | kubectl delete -f -`

2.  Geneate COSMO Template

    Next, from there YAML create `COSMO Template`

    Command example is here.

    ```sh
    kustomize build . | cosmoctl tmpl gen --workspace \
    --workspace-urlbase='http://{{NETRULE_GROUP}}-{{INSTANCE}}-{{NAMESPACE}}.cosmo.example.com' > cosmo-template.yaml
    ```

    > ✅Note: 
    >
    > Be sure to execute with `--workspace` option. if not, it is not Workspace Template.

    By standerd input, cosmoctl read all Kubernetes YAMLs.

3.  Apply COSMO Template to Kubernetes cluster

    COSMO Template is standard Kubernetes YAML so you can apply via kubectl

    ```
    kubectl apply -f cosmo-template.yaml
    ```
    
## WorkspaceConfig

In order for COSMO to automatically run and stop Workspace pods or change the network configuration in Kubernetes resources, 
COSMO need to know which resources are for Workspace.

By default, they are recognized automatically in Template generation and called as `WorkspaceConfig`.

Here is the list of `WorkspaceConfig`

| Name | Description | Auto Recognition |
|:-----|:------------|:-----------------|
| Deployment Name | Deployment name of Workspace Pods. It is used for scaling Workspace. | true |
| Service Name | Service name of Workspace WebIDE. It is used for dynamic netwoking configuration and auto-authentication| true |
| Service Main Port Name | Service port of Workspace WebIDE. It is used for dynamic netwoking configuration and auto-authentication | true |
| Ingress Name | Ingress name of Workspace WebIDE | true |
| URLBase | Workspace URL Base | false |


> ⚠️Caution:
>
> `URLBase` must be given by `--workspace-urlbase` option manually when generating Workspace Template.
> 
> If several deployments or services found, auto recognition will fail and you need specify `WorkspaceConfig` manually by command options.

You can see them in generated Template Annotation.

```yaml
apiVersion: cosmo-workspace.github.io/v1alpha1
kind: Template
metadata:
  annotations:
    workspace.cosmo-workspace.github.io/deployment: code-server
    workspace.cosmo-workspace.github.io/ingress: code-server
    workspace.cosmo-workspace.github.io/service: code-server
    workspace.cosmo-workspace.github.io/service-main-port: http
    workspace.cosmo-workspace.github.io/urlbase: https://{{NETRULE_GROUP}}-{{INSTANCE}}-{{NAMESPACE}}.cosmo.example.com
  labels:
    cosmo-workspace.github.io/type: workspace
  name: code-server
...
```

### URLBase

`URLBase` is a skelton URL for COSMO Workspace dynamic networks.

When you open new port, URL is generated automatically based on the `URLBase`. 

We recommend the following `URLBase`

- For using custom domain: 

  `https://{{NETRULE_GROUP}}-{{WORKSPACE}}-{{USER_NAME}}.cosmo.example.com`

- For using auto-generated LoadBalancer name without custom domain: 

  `https://{{LOADBALANCER}}:{{PORT_NUMBER}}`

Rules:

- start with `http://` or `https://`
- hostname and port can contain fixed value like `.cosmo.exmaple.com` or variables like `{{WOEKSPACE}}`
- do not add Path '/' in sufix

<details>
<summary>Available variables:</summary>

| Var                 | Description |
|:--------------------|:------------|
| {{NETRULE_GROUP}}   | Name of each Network rule |
| {{WORKSPACE}}       | Workspace name |
| {{INSTANCE}}        | Instance name (same as Workspace name) |
| {{USER_NAME}}          | Workspace owner user ID |
| {{NAMESPACE}}       | Namespace name |
| {{NETRULE_NAME}}    | Network rule name |
| {{PORT_NUMBER}}     | Service Port number |
| {{NODEPORT_NUMBER}} | Service NodePort number |
| {{LOADBALANCER}}    | Service LoadBalancer hostname or IP |

</details><br>

## Workspace

Workspace is a instance of Workspace Template.

When you create Workspace, actual Workspace Pod will be started.

You can create Workspace via Kubectl with YAML, `cosmoctl` or `COSMO Dashboard UI`.

Here is a example of Kubernetes YAML

```yaml
apiVersion: cosmo-workspace.github.io/v1alpha1
kind: Workspace
metadata:
  name: my-workspace
  namespace: cosmo-user-tom
spec:
  replicas: 1
  template:
    name: code-server
  network:
  - networkRule: webide
    group: webide
    httpPath: /
    portNumber: 8080
  - networkRule: nodejs
    group: nodejs
    httpPath: /
    portNumber: 3000
```

Save it to the file `ws.yaml` and create Workspace.

```sh
kubectl create -f ws.yaml
```

### Workspace Status

Once you create Workspace, you can see Workspace Status via kubectl

```sh
kubectl describe ws my-workspace
```

Exmple output

```
...
Spec:
  Network:
  - Group:               webide
    Host:                webide-my-workspace-tom.cosmo.exmaple.com
    Http Path:           /
    Port Name:           http
    Port Number:         8080
    Public:              false
    Target Port Number:  37299
  - Group:               nodejs
    Host:                nodejs-my-workspace-tom.cosmo.exmaple.com
    Http Path:           /
    Port Name:           nodejs
    Port Number:         3000
    Public:              false
    Target Port Number:  37941
  Replicas:              1
  Template:
    Name:  code-server
Status:
  Config:
    Deployment Name:         code-server
    Ingress Name:            code-server
    Main Service Port Name:  webide
    Service Name:            code-server
    Urlbase:                 https://{{NETRULE_GROUP}}-{{WORKSPACE}}-{{USER_NAME}}.cosmo.exmaple.com/
  Instance:
    API Version: cosmo-workspace.github.io/v1alpha1
    Kind: Instance
    Name: my-workspace
    Update Timestamp:  2021-10-12T09:33:14Z
  Phase:               Running
  Urls:
    Webide:  https://webide-my-workspace-tom.cosmo.exmaple.com/
    Nodejs:  https://nodejs-my-workspace-tom.cosmo.exmaple.com/
```

When you create `Workspace`, you can also see the Kubernetes resource `Instance` is created.

See [CRD-DESIGN.md](https://github.com/cosmo-workspace/cosmo/blob/main/docs/CRD-DESIGN.md) for deepdive about `Instance`.

# Generated by cosmoctl template command
apiVersion: cosmo.cosmo-workspace.github.io/v1alpha1
kind: Template
metadata:
  annotations:
    cosmo/sysns-user-addon: cosmo-system
  creationTimestamp: null
  labels:
    cosmo/type: user-addon
  name: eks-iamserviceaccount
spec:
  description: create IAM Role for Service Account in user namespace.
  rawYaml: |
    apiVersion: batch/v1
    kind: Job
    metadata:
      labels:
        cosmo/instance: '{{INSTANCE}}'
        cosmo/template: '{{TEMPLATE}}'
      name: '{{INSTANCE}}-job'
      namespace: '{{NAMESPACE}}'
    spec:
      template:
        metadata:
          labels:
            cosmo/instance: '{{INSTANCE}}'
            cosmo/template: '{{TEMPLATE}}'
        spec:
          containers:
          - args:
            - create
            - iamserviceaccount
            - --region={{AWS_REGION}}
            - --cluster={{CLUSTER_NAME}}
            - --name={{SERVICE_ACCOUNT}}
            - --namespace={{USER_NAMESPACE}}
            - --attach-policy-arn=arn:aws:iam::aws:policy/AWSCodeCommitPowerUser,arn:aws:iam::aws:policy/AWSCodeArtifactReadOnlyAccess
            - --override-existing-serviceaccounts
            - --approve
            - --verbose=5
            image: weaveworks/eksctl:0.71.0
            name: eksctl
          restartPolicy: Never
          serviceAccountName: eksctl
  requiredVars:
  - default: default
    var: SERVICE_ACCOUNT
  - var: CLUSTER_NAME
  - var: AWS_REGION

